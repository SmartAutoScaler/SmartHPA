name: Release SmartHPA

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

env:
  REGISTRY: quay.io
  IMAGE_NAME: sarabala1979/smarthpa

jobs:
  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    # Only run if it's a version tag
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '.')
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Quay.io
      uses: docker/login-action@v3
      with:
        registry: quay.io
        username: ${{ secrets.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix=sha-,format=short

    - name: Generate CRDs and code
      run: |
        make generate
        make manifests

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
        build-args: |
          BUILDPLATFORM=linux/amd64

    - name: Generate install.yaml with release image
      id: install
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        RELEASE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
        
        # Update the manager image in kustomization
        cd config/manager
        kustomize edit set image controller=${RELEASE_IMAGE}
        cd ../..
        
        # Build complete install.yaml using kustomize
        kustomize build config/default > install.yaml
        
        # Verify the image was updated
        if grep -q "${RELEASE_IMAGE}" install.yaml; then
          echo "‚úÖ install.yaml updated with image: ${RELEASE_IMAGE}"
        else
          echo "‚ö†Ô∏è Image not found in install.yaml, updating manually..."
          sed -i "s|image:.*controller.*|image: ${RELEASE_IMAGE}|g" install.yaml
        fi
        
        echo "Generated install.yaml:"
        head -100 install.yaml
        echo "..."
        echo "Total lines: $(wc -l < install.yaml)"
        
        # Output for next steps
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "image=${RELEASE_IMAGE}" >> $GITHUB_OUTPUT

    - name: Upload install.yaml as artifact
      uses: actions/upload-artifact@v4
      with:
        name: install-yaml
        path: install.yaml
        retention-days: 90

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## SmartHPA ${{ github.ref_name }}
          
          Smart Horizontal Pod Autoscaler for Kubernetes - Schedule-based HPA configuration management.
          
          ---
          
          ### üìã Prerequisites
          
          - Kubernetes cluster v1.26+
          - kubectl configured to access your cluster
          - HPA already configured for your deployments
          
          ---
          
          ### üöÄ Installation
          
          ```bash
          kubectl apply -f https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/install.yaml
          ```
          
          ---
          
          ### ‚úÖ Verify Installation
          
          ```bash
          # Check controller is running
          kubectl get pods -n smarthpa-system
          
          # Check CRD is installed
          kubectl get crd smarthorizontalpodautoscalers.autoscaling.sarabala.io
          
          # View controller logs
          kubectl logs -n smarthpa-system -l control-plane=controller-manager -f
          ```
          
          ---
          
          ### üìù Usage Example
          
          Create a SmartHPA resource to manage your HPA based on schedules:
          
          ```yaml
          apiVersion: autoscaling.sarabala.io/v1alpha1
          kind: SmartHorizontalPodAutoscaler
          metadata:
            name: my-app-smart-hpa
            namespace: default
          spec:
            hpaRef:
              name: my-app-hpa
            defaultConfig:
              minReplicas: 2
              maxReplicas: 10
            triggers:
              - name: business-hours
                schedule:
                  startTime: "09:00"
                  endTime: "18:00"
                  days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
                  timezone: "America/New_York"
                config:
                  minReplicas: 5
                  maxReplicas: 20
          ```
          
          ```bash
          kubectl apply -f my-smart-hpa.yaml
          ```
          
          ---
          
          ### üóëÔ∏è Uninstall
          
          ```bash
          kubectl delete -f https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/install.yaml
          ```
          
          ---
          
          ### üì¶ What's Included
          
          | Component | Description |
          |-----------|-------------|
          | CRD | SmartHorizontalPodAutoscaler custom resource definition |
          | Controller | Manages HPA configurations based on schedules |
          | RBAC | ClusterRole, ClusterRoleBinding, ServiceAccount |
          | Namespace | `smarthpa-system` for controller deployment |
          
          ---
          
          ### üê≥ Docker Image
          
          ```bash
          docker pull ${{ steps.install.outputs.image }}
          ```
          
          ---
          
          ### üìö Documentation
          
          For more information, visit the [SmartHPA Repository](https://github.com/${{ github.repository }}).
        files: |
          install.yaml
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
