name: Build and Test

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Install dependencies
      run: |
        go mod download
        go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0

    - name: Generate CRDs and code
      run: |
        make generate
        make manifests

    - name: Build
      run: make build

    - name: Run tests
      run: make test

    - name: Calculate coverage
      id: coverage
      run: |
        # Calculate coverage percentage from cover.out
        COVERAGE=$(go tool cover -func=cover.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage: $COVERAGE%"
        
        # Create coverage badge color
        if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          COLOR="brightgreen"
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          COLOR="green"
        elif (( $(echo "$COVERAGE >= 40" | bc -l) )); then
          COLOR="yellow"
        else
          COLOR="orange"
        fi
        echo "color=$COLOR" >> $GITHUB_OUTPUT
        
        # Create badge JSON for Shields.io endpoint
        mkdir -p badges
        cat > badges/coverage.json << EOF
        {
          "schemaVersion": 1,
          "label": "coverage",
          "message": "${COVERAGE}%",
          "color": "${COLOR}"
        }
        EOF

    - name: Upload coverage badge
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-badge
        path: badges/coverage.json
        retention-days: 90

    - name: Create Coverage Badge (Gist)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' && secrets.GIST_TOKEN != '' && secrets.GIST_ID != ''
      continue-on-error: true
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_TOKEN }}
        gistID: ${{ secrets.GIST_ID }}
        filename: smarthpa-coverage.json
        label: coverage
        message: ${{ steps.coverage.outputs.coverage }}%
        color: ${{ steps.coverage.outputs.color }}

    - name: Coverage Badge Info
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ“Š Coverage: ${{ steps.coverage.outputs.coverage }}%"
        echo "ğŸ¨ Badge Color: ${{ steps.coverage.outputs.color }}"
        if [ -z "${{ secrets.GIST_TOKEN }}" ] || [ -z "${{ secrets.GIST_ID }}" ]; then
          echo "â„¹ï¸  Note: GIST_TOKEN or GIST_ID not configured."
          echo "   The coverage badge will not auto-update in README."
          echo "   See docs/COVERAGE_BADGE_SETUP.md for setup instructions."
        else
          echo "âœ… Coverage badge should be updated in Gist"
        fi

    # - name: Setup Kind Cluster
    #   uses: helm/kind-action@v1.9.0
    #   with:
    #     version: "v0.20.0"
    #     cluster_name: "kind"

    # - name: Run e2e tests
    #   run: make test-e2e

    - name: Upload coverage
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./cover.out
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    # - name: Check if working tree is dirty
    #   run: |
    #     if [[ $(git status --porcelain) ]]; then
    #       echo "Working tree is dirty after generating files"
    #       git status --porcelain
    #       git diff
    #       exit 1
    #     fi
